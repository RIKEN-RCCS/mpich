page: gen_abi
    module: perl
    $call load_mpi_abi_h
    $call dump_mpi_abi_internal_h

subcode: load_mpi_abi_h
    my @extern_list
    my @internal_h
    &call open_r, mpi_abi.h
        chomp
        $if /MPI_ABI_H_INCLUDED/
            NOOP
        $elif /^extern struct \w+ abi_mpi_\w+;/
            NOOP
        $elif /^\s*int MPI_(SOURCE|TAG|ERROR);/
            push @internal_h, $_
        $elif /^(int|double) (P?MPI\w+)\((.*)\);/ -> $T, $name, $param
            # MPI functions prototypes
            $param=~s/\bMPI_/ABI_/g
            push @internal_h, "$T $name($param) MPICH_API_PUBLIC;"
        $else
            s/\bMPI_/ABI_/g
            push @internal_h, $_

subcode: dump_mpi_abi_internal_h
    &call open_W, "mpi_abi_internal.h"
        $call dump_copyright
        $print "#ifndef MPI_ABI_INTERNAL_H_INCLUDED"
        $print "#define MPI_ABI_INTERNAL_H_INCLUDED"
        $print
        $print "/* hack to prevent inclusion of mpi_proto.h */"
        $print "#define MPI_PROTO_H_INCLUDED"
        $print "/* hack to prevent inclusion of mpio prototypes */"
        $print "#define HAVE_MPIO_PROTOTYPES"
        $print "enum QMPI_Functions_enum;"
        $print "#include \"mpichconf.h\""
        $print "#include \"mpiimpl.h\""
        $print
        $foreach $l in @internal_h
            $print $l
        $print
        $print "#endif /* MPI_ABI_INTERNAL_H_INCLUDED */"

subcode: dump_copyright
    $print "/*"
    $print " * Copyright (C) by Argonne National Laboratory"
    $print " *     See COPYRIGHT in top-level directory"
    $print " */"
    $print "/* This file is automatically generated. DO NOT EDIT. */"
    $print
